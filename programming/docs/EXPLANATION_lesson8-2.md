# lesson8-2.py の詳細解説

## インポート文（1-3行目）

```python
import numpy as np
```
- **目的**: NumPyライブラリをインポート
- **説明**: 数値計算用のライブラリで、配列演算や数学関数を提供します
- **`np`**: numpyの短縮名（エイリアス）

```python
import matplotlib.pyplot as plt
```
- **目的**: Matplotlibのpyplotモジュールをインポート
- **説明**: グラフ描画用のライブラリ

```python
from scipy.optimize import curve_fit
```
- **目的**: SciPyのcurve_fit関数をインポート
- **説明**: データに曲線をフィッティングする関数

## 関数定義（5-6行目）

```python
def hubble_law(D, H):
```
- **目的**: ハッブルの法則を表す関数を定義
- **引数**:
  - `D`: 距離（Distance）[Mpc: メガパーセク]
  - `H`: ハッブル定数（Hubble constant）[km/s/Mpc]
- **ハッブルの法則**: 銀河までの距離と後退速度が比例する法則

```python
    return H * D
```
- **目的**: ハッブルの法則に基づいて後退速度を計算
- **式**: `v = H × D`（後退速度 = ハッブル定数 × 距離）
- **戻り値**: 後退速度（v）[km/s]

## メイン処理（8行目以降）

```python
if __name__ == '__main__':
```
- **目的**: このファイルが直接実行された場合のみ実行
- **説明**: 他のファイルからインポートされた場合は実行されない

### データ読み込み（9-21行目）

```python
    data_lines = []
```
- **目的**: データを格納する空のリストを作成
- **説明**: ファイルから読み込んだデータを一時的に保存

```python
    with open('Hubble.dat', 'r') as f:
```
- **目的**: ファイルを開く
- **`'Hubble.dat'`**: 読み込むファイル名
- **`'r'`**: 読み込みモード（read mode）
- **`with ... as f:`**: ファイルを安全に開く構文（自動的に閉じる）

```python
        for line in f:
```
- **目的**: ファイルの各行を順番に読み込む
- **説明**: ファイル全体を1行ずつ処理するループ

```python
            line = line.strip()
```
- **目的**: 行の前後の空白文字（スペース、改行など）を削除
- **`strip()`**: 文字列の前後の空白を削除するメソッド

```python
            if not line or line.startswith('#'):
```
- **目的**: 空行やコメント行をスキップする条件
- **`not line`**: 行が空（空文字列）の場合
- **`line.startswith('#')`**: 行が`#`で始まる場合（コメント行）
- **`or`**: どちらか一方でも真なら条件が真

```python
                continue
```
- **目的**: ループの残りの処理をスキップして次の行へ
- **説明**: 空行やコメント行の場合は処理しない

```python
            parts = line.split()
```
- **目的**: 行を空白で区切ってリストに分割
- **`split()`**: デフォルトで空白文字で区切る
- **例**: `"M31 -298 0.77"` → `["M31", "-298", "0.77"]`

```python
            try:
```
- **目的**: エラーが発生する可能性がある処理を実行
- **説明**: 後続の処理でエラーが起きてもプログラムが止まらないようにする

```python
                velocity = float(parts[-2])
```
- **目的**: 後退速度の値を読み取る
- **`parts[-2]`**: リストの後ろから2番目の要素（最後から2番目）
- **`float(...)`**: 文字列を実数（浮動小数点数）に変換
- **説明**: データ形式が「銀河名 後退速度 距離」なので、後ろから2番目が後退速度

```python
                distance = float(parts[-1])
```
- **目的**: 距離の値を読み取る
- **`parts[-1]`**: リストの最後の要素
- **説明**: 最後の列が距離

```python
                data_lines.append([distance, abs(velocity)])
```
- **目的**: 読み取ったデータをリストに追加
- **`[distance, abs(velocity)]`**: 距離と後退速度のペアをリストとして作成
- **`abs(velocity)`**: 後退速度の絶対値（負の値も正の値に変換）
- **`append()`**: リストに要素を追加

```python
            except (ValueError, IndexError):
```
- **目的**: エラーが発生した場合の処理
- **`ValueError`**: 数値変換に失敗した場合（文字列を数値に変換できない）
- **`IndexError`**: リストのインデックスが範囲外の場合（要素が足りない）

```python
                continue
```
- **目的**: エラーが起きた行はスキップして次の行へ

### データ配列の作成（23-25行目）

```python
    data = np.array(data_lines)
```
- **目的**: PythonのリストをNumPy配列に変換
- **説明**: NumPy配列にすると数学演算が高速になる

```python
    distance = data[:, 0]
```
- **目的**: データの1列目（距離）を抽出
- **`[:, 0]`**: すべての行の0番目の列

```python
    velocity = data[:, 1]
```
- **目的**: データの2列目（後退速度）を抽出

### フィッティング実行（27-29行目）

```python
    popt, pcov = curve_fit(hubble_law, distance, velocity)
```
- **目的**: データにハッブルの法則をフィッティング
- **`hubble_law`**: フィッティングに使う関数（`v = H × D`）
- **`distance, velocity`**: フィッティング対象のデータ
- **`popt`**: 最適化されたパラメータ（この場合は`H`の値）
- **`pcov`**: パラメータの共分散行列（不確かさを計算するため）

```python
    H_fit = popt[0]
```
- **目的**: フィッティング結果のハッブル定数を取得
- **`popt[0]`**: 最適化されたパラメータの最初（唯一）の要素

```python
    H_std = np.sqrt(pcov[0, 0])
```
- **目的**: ハッブル定数の標準偏差（不確かさ）を計算
- **`pcov[0, 0]`**: 共分散行列の(0,0)要素（ハッブル定数の分散）
- **`np.sqrt()`**: 平方根（標準偏差 = 分散の平方根）

### 結果表示（31-35行目）

```python
    print(f"フィッティング結果:")
```
- **目的**: フィッティング結果の見出しを表示

```python
    print(f"  ハッブル定数 H = {H_fit:.2f} ± {H_std:.2f} km/s/Mpc")
```
- **目的**: ハッブル定数の値を表示
- **`{H_fit:.2f}`**: ハッブル定数を小数点以下2桁で表示
- **`± {H_std:.2f}`**: 標準偏差（誤差）を小数点以下2桁で表示
- **`±`**: プラスマイナスの記号

```python
    age_billion_years = 9.778e11 / H_fit / 1e9
```
- **目的**: 宇宙年齢を十億年単位で計算
- **式の説明**:
  - `t = 1/H`（ハッブル定数の逆数が宇宙年齢の目安）
  - 単位変換の係数: `9.778e11` = `3.086e19 / 3.156e7`（Mpcをkmに、秒を年に変換）
  - `/ 1e9`: 年を十億年（billion years）に変換
- **`9.778e11`**: 科学記数法（9.778 × 10^11）
- **`1e9`**: 10^9 = 1,000,000,000（10億）

```python
    print(f"\n宇宙年齢の概算: {age_billion_years:.2f} 十億年")
```
- **目的**: 宇宙年齢を表示
- **`\n`**: 改行（前の出力との間に空行を入れる）

### フィッティング曲線の計算（37-38行目）

```python
    D_fit = np.linspace(0, distance.max() * 1.1, 100)
```
- **目的**: フィッティング直線を描画するための距離の値を生成
- **`0`**: 開始値（距離0から開始）
- **`distance.max() * 1.1`**: 最大距離の1.1倍まで（少し余裕を持たせる）
- **`100`**: 100個の点を生成

```python
    v_fit = hubble_law(D_fit, H_fit)
```
- **目的**: フィッティングしたハッブル定数を使って後退速度を計算
- **説明**: `D_fit`の各点について、`v = H_fit × D`で後退速度を計算

### グラフ描画（40-50行目）

```python
    plt.figure(figsize=(10, 6))
```
- **目的**: 新しい図を作成
- **`figsize=(10, 6)`**: 幅10インチ、高さ6インチ

```python
    plt.scatter(distance, velocity, color='blue', s=50, alpha=0.7, label='Data')
```
- **目的**: データ点を散布図として描画
- **`s=50`**: 点のサイズ（lesson8-1より大きめ）
- **`alpha=0.7`**: 透明度（少し透けている）

```python
    plt.plot(D_fit, v_fit, 'r-', linewidth=2, label=f'Fit (H = {H_fit:.2f} km/s/Mpc)')
```
- **目的**: フィッティング直線を描画
- **`'r-'`**: 赤色の実線
- **`label=f'Fit (H = {H_fit:.2f} km/s/Mpc)'`**: 凡例にハッブル定数の値も表示

```python
    plt.xlabel('Distance D [Mpc]', fontsize=12)
```
- **目的**: x軸のラベルを設定
- **説明**: 距離（メガパーセク単位）

```python
    plt.ylabel('Recession velocity v [km/s]', fontsize=12)
```
- **目的**: y軸のラベルを設定
- **説明**: 後退速度（km/s単位）

```python
    plt.title('Hubble Law Fit', fontsize=14)
```
- **目的**: グラフのタイトルを設定

```python
    plt.legend(fontsize=10)
```
- **目的**: 凡例を表示

```python
    plt.grid(True, alpha=0.3)
```
- **目的**: グリッド（格子線）を表示
- **`alpha=0.3`**: 薄く表示

```python
    plt.tight_layout()
```
- **目的**: レイアウトを自動調整

```python
    plt.savefig('lesson8-2.png', dpi=300, bbox_inches='tight')
```
- **目的**: グラフをPNGファイルとして保存
- **`dpi=300`**: 高解像度で保存

```python
    plt.close()
```
- **目的**: 図を閉じてメモリを解放

### 完了メッセージ（52行目）

```python
    print("グラフを lesson8-2.png に保存しました。")
```
- **目的**: 保存完了のメッセージを表示

## 補足説明

### ハッブルの法則について
- 1929年にエドウィン・ハッブルが発見
- 銀河までの距離が遠いほど、後退速度が大きい
- 式: `v = H × D`
- ハッブル定数`H`の値から宇宙の年齢を推定できる

### 単位について
- **Mpc**: メガパーセク（1 Mpc ≈ 3.086 × 10^19 km）
- **km/s/Mpc**: ハッブル定数の単位

### データファイルの形式
- `Hubble.dat`は「銀河名 後退速度[km/s] 距離[Mpc]」の形式
- プログラムは後退速度と距離の数値データのみを読み取る

