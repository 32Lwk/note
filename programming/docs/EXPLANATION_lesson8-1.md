# lesson8-1.py の詳細解説

## インポート文（1-3行目）

```python
import numpy as np
```
- **目的**: NumPyライブラリをインポート
- **説明**: 数値計算用のライブラリで、配列演算や数学関数を提供します
- **`np`**: numpyの短縮名（エイリアス）として使用

```python
import matplotlib.pyplot as plt
```
- **目的**: Matplotlibのpyplotモジュールをインポート
- **説明**: グラフ描画用のライブラリです
- **`plt`**: matplotlib.pyplotの短縮名

```python
from scipy.optimize import curve_fit
```
- **目的**: SciPyのcurve_fit関数をインポート
- **説明**: データに曲線をフィッティング（最適な曲線を当てはめる）する関数
- **`from ... import`**: 特定の関数だけを直接インポート

## 関数定義（5-6行目）

```python
def lorentz_linear(x, a, b, c, d):
```
- **目的**: ローレンツ分布と線形関数の和を表す関数を定義
- **引数**:
  - `x`: 独立変数（横軸の値）
  - `a`: ピークの位置（ローレンツ分布の中心）
  - `b`: 半値全幅のパラメータ（分布の広がりを決める）
  - `c`: 線形項の傾き
  - `d`: 線形項の切片
- **`def`**: 関数を定義するキーワード

```python
    return (b / np.pi) / ((x - a)**2 + b**2) + c * x + d
```
- **目的**: ローレンツ分布 + 線形関数の値を返す
- **式の説明**:
  - `(b / np.pi) / ((x - a)**2 + b**2)`: ローレンツ（コーシー）分布
  - `c * x + d`: 線形関数（直線）
  - これらを足し合わせた値を返す
- **`**`**: 累乗演算子（例: `x**2` は xの2乗）
- **`np.pi`**: 円周率π（約3.14159...）

## メイン処理（8行目以降）

```python
if __name__ == '__main__':
```
- **目的**: このファイルが直接実行された場合のみ実行
- **説明**: 
  - `__name__`: 実行中のモジュール名を格納
  - 直接実行時は `'__main__'` になる
  - 他のファイルからインポートされた場合は実行されない

### データ読み込み（9-11行目）

```python
    data = np.loadtxt('testdata04.dat', comments='#')
```
- **目的**: テキストファイルから数値データを読み込む
- **`'testdata04.dat'`**: 読み込むファイル名
- **`comments='#'`**: `#`で始まる行をコメントとして無視
- **戻り値**: 2次元配列（各列がデータの種類を表す）

```python
    x_data = data[:, 0]
```
- **目的**: データの1列目（0番目の列）を抽出
- **`[:, 0]`**: 
  - `:` は「すべての行」
  - `0` は「0番目の列（1列目）」
  - つまり、すべての行の1列目を取得

```python
    y_data = data[:, 1]
```
- **目的**: データの2列目（1番目の列）を抽出
- **説明**: `x_data`と同様に、すべての行の2列目を取得

### 初期値の設定（13-18行目）

```python
    p0 = [
```
- **目的**: フィッティングの初期パラメータ値を格納するリスト
- **`p0`**: "parameter 0"（パラメータの初期値）の略

```python
        x_data[np.argmax(y_data)],
```
- **目的**: パラメータ`a`の初期値（ピーク位置）
- **`np.argmax(y_data)`**: `y_data`の最大値がある位置（インデックス）を返す
- **`x_data[...]`**: その位置に対応する`x_data`の値を取得
- **結果**: yが最大になるxの値が`a`の初期値

```python
        (x_data.max() - x_data.min()) / 10.0,
```
- **目的**: パラメータ`b`の初期値（分布の広がり）
- **`x_data.max()`**: xデータの最大値
- **`x_data.min()`**: xデータの最小値
- **`/ 10.0`**: 範囲の10分の1を初期値として使用

```python
        (y_data[-1] - y_data[0]) / (x_data[-1] - x_data[0]) if len(x_data) > 1 else 0.0,
```
- **目的**: パラメータ`c`の初期値（線形項の傾き）
- **`y_data[-1]`**: 最後の要素（`y_data[len(y_data)-1]`と同じ）
- **`y_data[0]`**: 最初の要素
- **計算**: (最後のy - 最初のy) / (最後のx - 最初のx) で傾きを推定
- **`if len(x_data) > 1 else 0.0`**: データが1個以下なら0.0を返す（エラー回避）

```python
        np.mean(y_data) * 0.1
```
- **目的**: パラメータ`d`の初期値（線形項の切片）
- **`np.mean(y_data)`**: yデータの平均値
- **`* 0.1`**: 平均の10%を初期値として使用

### フィッティング実行（20-21行目）

```python
    popt, _ = curve_fit(lorentz_linear, x_data, y_data, p0=p0, maxfev=5000)
```
- **目的**: データに曲線をフィッティング（最適なパラメータを求める）
- **`lorentz_linear`**: フィッティングに使う関数
- **`x_data, y_data`**: フィッティング対象のデータ
- **`p0=p0`**: パラメータの初期値
- **`maxfev=5000`**: 最大評価回数（計算回数の上限）
- **`popt`**: 最適化されたパラメータ値（optimized parameters）
- **`_`**: 共分散行列（使わないので無視）

```python
    a, b, c, d = popt
```
- **目的**: フィッティング結果のパラメータを個別の変数に代入
- **説明**: `popt`は配列なので、各要素を変数に分解
- **`a, b, c, d`**: それぞれ最適化されたパラメータ値

### 結果表示（23-27行目）

```python
    print(f"フィッティング結果:")
```
- **目的**: フィッティング結果の見出しを表示
- **`f"..."`**: f-string（フォーマット済み文字列）、変数を直接埋め込める

```python
    print(f"  a = {a:.6f}")
```
- **目的**: パラメータ`a`の値を表示
- **`{a:.6f}`**: 
  - `a`の値を表示
  - `:.6f`: 小数点以下6桁で表示（floating point形式）

```python
    print(f"  b = {b:.6f}")
```
- **目的**: パラメータ`b`の値を表示（同様に6桁表示）

```python
    print(f"  c = {c:.6f}")
```
- **目的**: パラメータ`c`の値を表示

```python
    print(f"  d = {d:.6f}")
```
- **目的**: パラメータ`d`の値を表示

### フィッティング曲線の計算（29-30行目）

```python
    x_fit = np.linspace(x_data.min(), x_data.max(), 1000)
```
- **目的**: フィッティング曲線を描画するためのx座標を生成
- **`np.linspace(開始, 終了, 個数)`**: 開始から終了まで等間隔の値を生成
- **`x_data.min()`**: xデータの最小値
- **`x_data.max()`**: xデータの最大値
- **`1000`**: 1000個の点を生成（滑らかな曲線を描くため）

```python
    y_fit = lorentz_linear(x_fit, a, b, c, d)
```
- **目的**: フィッティングした関数を使ってy座標を計算
- **説明**: `x_fit`の各点について、フィッティングしたパラメータで関数値を計算

### グラフ描画（32-42行目）

```python
    plt.figure(figsize=(10, 6))
```
- **目的**: 新しい図（figure）を作成
- **`figsize=(10, 6)`**: 図のサイズ（幅10インチ、高さ6インチ）

```python
    plt.scatter(x_data, y_data, color='blue', s=30, alpha=0.6, label='Data')
```
- **目的**: データ点を散布図として描画
- **`x_data, y_data`**: 描画するデータのx座標とy座標
- **`color='blue'`**: 点の色を青に
- **`s=30`**: 点のサイズ
- **`alpha=0.6`**: 透明度（0.0=完全透明、1.0=不透明）
- **`label='Data'`**: 凡例に表示する名前

```python
    plt.plot(x_fit, y_fit, 'r-', linewidth=2, label='Fit')
```
- **目的**: フィッティング曲線を線で描画
- **`x_fit, y_fit`**: 描画する曲線のx座標とy座標
- **`'r-'`**: 赤色（red）の実線（solid line）
- **`linewidth=2`**: 線の太さ
- **`label='Fit'`**: 凡例に表示する名前

```python
    plt.xlabel('x', fontsize=12)
```
- **目的**: x軸のラベルを設定
- **`fontsize=12`**: フォントサイズ

```python
    plt.ylabel('y', fontsize=12)
```
- **目的**: y軸のラベルを設定

```python
    plt.title('Lorentz (Cauchy) Distribution + Linear Function Fit', fontsize=14)
```
- **目的**: グラフのタイトルを設定

```python
    plt.legend(fontsize=10)
```
- **目的**: 凡例を表示
- **説明**: `label`で指定した名前が凡例に表示される

```python
    plt.grid(True, alpha=0.3)
```
- **目的**: グリッド（格子線）を表示
- **`alpha=0.3`**: グリッドの透明度（薄く表示）

```python
    plt.tight_layout()
```
- **目的**: レイアウトを自動調整
- **説明**: ラベルやタイトルが切れないように余白を調整

```python
    plt.savefig('lesson8-1.png', dpi=300, bbox_inches='tight')
```
- **目的**: グラフをPNGファイルとして保存
- **`'lesson8-1.png'`**: 保存するファイル名
- **`dpi=300`**: 解像度（dots per inch）、高解像度で保存
- **`bbox_inches='tight'`**: 余分な余白を削除

```python
    plt.close()
```
- **目的**: 図を閉じる
- **説明**: メモリを解放するために必要

### 完了メッセージ（44行目）

```python
    print("グラフを lesson8-1.png に保存しました。")
```
- **目的**: 保存完了のメッセージを表示

